<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pitch Call</title>
<style>
  body {
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    background: #f5f5f5;
  }

  h1 { 
    margin-top: 2rem;
    margin-bottom: 2rem;
    font-size: 2rem;
  }

  .button-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    width: 100%;
    max-width: 400px;
    margin-bottom: 2rem;
  }

  /* MAIN BUTTONS (Orange with Black text) */
  button {
    padding: 1.5rem;
    font-size: 1.3rem;
    border: none;
    border-radius: 12px;
    background: #ff8800;       /* ORANGE */
    color: black;              /* BLACK TEXT */
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    transition: background 0.2s;
  }

  button:hover { background: #cc6d00; }

  /* CANCEL BUTTONS (Black with White text) */
  button.cancel {
    background: #000000;
    color: white;
  }

  button.cancel:hover {
    background: #333333;
  }

  /* CHANNEL BUTTONS (Orange with Black text) */
  .channels {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .channel-btn {
    background: #ff8800;   /* ORANGE */
    color: black;          /* BLACK TEXT */
    width: 50px;
    height: 50px;
    font-size: 1.2rem;
    border-radius: 50%;
    font-weight: bold;
    transition: background 0.2s;
  }

  /* SELECTED CHANNEL: Black with Orange text */
  .channel-btn.selected {
    background: #000000;
    color: #ff8800;
  }

  .status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  font-weight: bold;
}

.status .dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: red;
}

.status.connected .dot {
  background: #00c853; /* green */
}

.status.connected .label {
  color: #00c853;
}

.status.disconnected .label {
  color: red;
}

</style>


</head>
<body>
  <div class="topbar">
    <h1>EC Goodwin Pitch Call</h1>
  </div>
  

  <div class="button-grid" id="buttonGrid"></div>

  <div class="channels" id="channelButtons"></div>

  <div id="connectionStatus" class="status">
  <span class="dot red"></span>
  <span class="label">Disconnected</span>
  </div>

 <script>
  /************* GLOBALS *************/
  const mainOptions = [
    { label: 'Fastball', value: 'fastball' },
    { label: 'Curveball', value: 'curveball' },
    { label: 'Slider', value: 'slider' },
    { label: 'Changeup', value: 'changeup' },
    { label: 'Knuckleball', value: 'knuckleball' },
    { label: 'Fake', value: 'fake' },
    { label: 'Throw To', value: 'throwto' },
    { label: 'Cancel', value: 'cancel', class: 'cancel' }
  ];

  const subPitchOptions = [
    { label: 'Inside', value: 'inside' },
    { label: 'Outside', value: 'outside' },
    { label: 'High', value: 'high' },
    { label: 'Low', value: 'low' },
    { label: 'â€”', value: 'blank' },
    { label: 'Cancel', value: 'cancel', class: 'cancel' }
  ];

  const subThrowFakeOptions = [
    { label: '1st', value: '1st' },
    { label: '2nd', value: '2nd' },
    { label: '3rd', value: '3rd' },
    { label: 'HOLD', value: 'hold' },
    { label: 'SS', value: 'ss' },
    { label: 'PIT', value: 'pit' },
    { label: 'â€”', value: 'blank' },
    { label: 'Cancel', value: 'cancel', class: 'cancel' }
  ];

  const buttonGrid = document.getElementById('buttonGrid');
  const channelContainer = document.getElementById('channelButtons');
  const statusEl = document.getElementById("connectionStatus");
  const statusDot = statusEl.querySelector(".dot");
  const statusLabel = statusEl.querySelector(".label");

  let inSubMenu = false;

  let chosenPitch = null;
  let selectedChannel = 1;

  /************* AUDIO SETUP *************/
  let audioUnlocked = false;
  const audioPlayer = new Audio();
  audioPlayer.preload = "auto";

  const soundFiles = [
    "fastball.mp3","curveball.mp3","slider.mp3","changeup.mp3","knuckleball.mp3",
    "inside.mp3","outside.mp3","high.mp3","low.mp3",
    "1st.mp3","2nd.mp3","3rd.mp3","hold.mp3","ss.mp3","pit.mp3","cancel.mp3","silence.mp3"
  ];

  // preload all sounds
  soundFiles.forEach(f => { const a = new Audio(f); a.preload="auto"; });

  function unlockAudio() {
    if (audioUnlocked) return;
    const a = new Audio("silence.mp3");
    a.play().then(() => { audioUnlocked = true; console.log("ðŸ”“ Audio unlocked"); }).catch(()=>{});
  }

  document.addEventListener("touchstart", unlockAudio, { once: true });
  document.addEventListener("click", unlockAudio, { once: true });

  function playSequence(files) {
    if (!audioUnlocked) return;

    let index = 0;
    audioPlayer.src = files[index];
    audioPlayer.play().catch(()=>{});

    audioPlayer.onended = () => {
      index++;
      if(index < files.length){
        audioPlayer.src = files[index];
        audioPlayer.play().catch(()=>{});
      }
    };
  }

  /************* UI BUTTONS *************/
function populateButtons(options, clickHandler){
  buttonGrid.innerHTML = '';
  options.forEach(opt=>{
    const btn = document.createElement('button');

    if (opt.value === 'cancel' && inSubMenu) {
      btn.textContent = 'Back';
    } else {
      btn.textContent = opt.label;
    }

    if(opt.class) btn.classList.add(opt.class);

    btn.onclick = () => {
      unlockAudio();

      // BACK behavior
      if (opt.value === 'cancel' && inSubMenu) {
        returnToMainMenu();
        return;
      }

      clickHandler(opt.value);
    };

    buttonGrid.appendChild(btn);
  });
}

function choosePitch(option){
  if(option==='cancel'){
    playCancel();
    sendPlay(['cancel.mp3']);
    return;
  }

  chosenPitch = option;
  inSubMenu = true;

  if(['fastball','curveball','slider','changeup','knuckleball'].includes(option)){
    populateButtons(subPitchOptions, playSub);
  } else {
    populateButtons(subThrowFakeOptions, playSub);
  }
}


  function playSub(option){
  if(option === 'cancel'){
    playCancel();
    sendPlay(['cancel.mp3']);
    return;
  }

  const files = option === 'blank'
    ? [`${chosenPitch}.mp3`]
    : [`${chosenPitch}.mp3`, `${option}.mp3`];

  playSequence(files);
  sendPlay(files);

  returnToMainMenu();
}

 function playCancel(){
  playSequence(['cancel.mp3']);
  returnToMainMenu();
}


  /************* CHANNELS *************/
  for(let i=1;i<=6;i++){
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.classList.add('channel-btn');
    if(i===selectedChannel) btn.classList.add('selected');

    btn.onclick = ()=>{
      unlockAudio();
      selectedChannel = i;
      document.querySelectorAll('.channel-btn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      console.log("Selected channel", i);
    };

    channelContainer.appendChild(btn);
  }

  populateButtons(mainOptions, choosePitch);

  /************* CONNECTION STATUS *************/
  function setConnected(connected){
    if(connected){
      statusEl.classList.add("connected");
      statusEl.classList.remove("disconnected");
      statusLabel.textContent = "Connected";
    } else {
      statusEl.classList.remove("connected");
      statusEl.classList.add("disconnected");
      statusLabel.textContent = "Disconnected";
    }
  }

  /************* WEBSOCKET + HEARTBEAT *************/
  let ws;
  let heartbeatInterval = null;
  let lastPong = 0;
  let reconnectTimer = null;
  let reconnectAttempts = 0;

  function returnToMainMenu() {
  inSubMenu = false;
  chosenPitch = null;
  populateButtons(mainOptions, choosePitch);
}


 function connectWebSocket(){
  ws = new WebSocket("wss://softballpitchcall.onrender.com"); // assign to global

  ws.addEventListener("open", () => {
    console.log("WebSocket OPEN");
    reconnectAttempts = 0;
    setConnected(true);
    startHeartbeat();
  });

  ws.addEventListener("close", (e) => {
    console.warn("WebSocket CLOSED", e.code, e.reason);
    setConnected(false);
    stopHeartbeat();
    scheduleReconnect();
  });

  ws.addEventListener("error", (e) => {
    console.error("WebSocket ERROR", e);
    setConnected(false);
    ws.close();
  });

  ws.addEventListener("message", (event) => {
    console.log("WebSocket MESSAGE received:", event.data);

    const data = JSON.parse(event.data);
    if (data.type === 'pong') {
      lastPong = Date.now();
      console.log("Pong received from server");
      return;
    }

    if (data.action === 'play' && data.channel === selectedChannel) {
      console.log("Playing audio sequence for files:", data.files);
      playSequence(data.files);
    }
  });
}


  function sendPlay(files){
    if(ws && ws.readyState===WebSocket.OPEN){
      ws.send(JSON.stringify({ action:'play', channel:selectedChannel, files }));
    }
  }

  function startHeartbeat(){
    lastPong = Date.now();
    heartbeatInterval = setInterval(()=>{
      if(!ws || ws.readyState!==WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type:'ping' }));
      if(Date.now() - lastPong > 10000){
        console.warn("Heartbeat timeout");
        ws.close();
      }
    },5000);
  }

  function stopHeartbeat(){
    if(heartbeatInterval){ clearInterval(heartbeatInterval); heartbeatInterval=null; }
  }

  function scheduleReconnect(){
    if(reconnectTimer) return;
    const delay = Math.min(1000 * 2 ** reconnectAttempts, 10000);
    console.log(`Reconnecting in ${delay}ms`);
    reconnectTimer = setTimeout(()=>{
      reconnectTimer = null;
      reconnectAttempts++;
      connectWebSocket();
    }, delay);
  }

  /************* INITIALIZE *************/
  connectWebSocket();
</script>

</body>

</html>
